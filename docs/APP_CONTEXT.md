# Nia's Alien Math Adventure — App Context

This document summarizes the project structure, core behavior, integrations, notable code patterns, and immediate concerns. Use this as a quick onboard/readme for maintainers or contributors.

## Quick facts
- App name: Nia's Alien Math Adventure
- Purpose: Educational, gamified arithmetic practice for a young user with a conversational AI character.
- Tech: React 18 + TypeScript, bundled with Vite. Uses browser Web Speech APIs and (optionally) Google GenAI via `@google/genai` for conversational replies.
- Where to run: Browser (client-side). Designed for local play; persistent state stored in `localStorage`.

---

## How to run
1. Install dependencies: `npm install`
2. Set the Gemini API key (optional): prefer `VITE_GEMINI_API_KEY` in a `.env` file for Vite. The repo previously referenced `GEMINI_API_KEY` and `API_KEY` in different locations — standardize to `VITE_GEMINI_API_KEY`.
3. Start dev server: `npm run dev`

Note: The speech features require a browser with the Web Speech APIs (speechSynthesis and SpeechRecognition).

---

## Project layout (important files)
- `index.tsx` — React entry.
- `App.tsx` — Global state, stage routing (Splash → ModeSelection → Playing → Rewards → ParentsCorner), conversation orchestration, answer handling.
- `components/` — UI components:
  - `Splashscreen.tsx` — landing screen.
  - `ModeSelection.tsx` — choose Addition / Multiplication / Division.
  - `GameCanvas.tsx` — visual scene & characters.
  - `GameUI.tsx` — question UI, options, top bar (points, streaks), controls (talk, mute, rewards, parent).
  - `RewardsUI.tsx` — redeem rewards.
  - `ParentsCorner.tsx` — PIN gate and reward fulfillment UI.
- `hooks/useLocalStorage.ts` — custom hook for persisting state.
- `utils/adaptiveLearning.ts` — problem generation & option/distractor generation.
- `utils/speech.ts` — wrappers around Web Speech APIs (speak, startListening, stopListening, cancelSpeech).
- `utils/gemini.ts` — thin wrapper around `@google/genai` used to get alien responses.
- `constants.ts` — problem set definitions, reward catalog, pre-written dialogue and pep talks.
- `types.ts` — TypeScript types and enums.

---

## Core behaviors
- Game stages are driven by a `stage` state persisted in localStorage.
- Problems are generated by `generateProblem(proficiency, mode)` and include `visual` metadata to render the 2D scene.
- Answer logic (`handleAnswer`) does correctness checks, awards points scaled by streaks, stores proficiency stats (attempts/correct), and triggers pep talks on success or consecutive struggles.
- Alien conversations: app selects casual lines on a timer (25s) and can also respond to user-initiated speech. Speech uses `speechSynthesis` and `SpeechRecognition` when available; AI replies are fetched from Gemini when an API key is configured.
- Rewards: Users spend points to redeem rewards; redeemed items are pushed to `redeemedRewards` (persisted) and can be marked fulfilled in Parent's Corner.

---

## Known issues & important notes
- Environment variable mismatch: README mentions `GEMINI_API_KEY` while `utils/gemini.ts` checks `process.env.API_KEY`. For Vite-based apps you should use `import.meta.env.VITE_GEMINI_API_KEY` and update the code + README.
- Security: Parent PIN is hard-coded as `1234` client-side (`ParentsCorner.tsx`) — this is insecure and easily bypassed by inspecting source. Consider a parent-set PIN or server-backed verification if security is needed.
- Speech lifecycle/race conditions:
  - A single, long-lived SpeechRecognition instance is reused; this can cause handler overwrite issues and race conditions between cancelSpeech and startListening.
  - `speak()` listens for `onvoiceschanged` per utterance; the voices loading flow may misfire if multiple speak calls occur quickly.
- Visual instability: `GameCanvas` uses `Math.random()` directly in render, causing visuals to change on re-render. Make visuals deterministic for the lifetime of a problem instance.
- Reward fulfillment logic: `handleFulfillReward` uses a closure that may incorrectly match or fail when multiple redeems share the same `id`. Use unique redeemed entry identifiers or match by `id + date`.
- Accessibility: Dynamic feedback overlays and audible cues should be backed by `aria-live` regions and keyboard accessible controls. Some interactive containers use `pointer-events-none` which can complicate focus flow.
- LocalStorage: `useLocalStorage` doesn't guard for non-browser contexts (SSR) and has no versioning/migration strategy.

---

## Recommended immediate fixes (priority)
1. Standardize the Gemini API env var (use `VITE_GEMINI_API_KEY`) and update `utils/gemini.ts` and README to match.
2. Protect localStorage usage against non-browser or error cases in `hooks/useLocalStorage.ts`.
3. Fix reward fulfillment to uniquely identify redeemed items when marking fulfilled (pass timestamp or unique redeem id).
4. Change speech recognition to create a fresh `SpeechRecognition` per `startListening` call and ensure proper cleanup after `stopListening`.
5. Stabilize `GameCanvas` visuals by deriving emoji/asset choices from `problem.key` (deterministic seed) and storing them with the problem.

---

## Testing suggestions
- Unit test `generateProblem` and `generateOptions` boundary cases (small and large numbers, distractor distribution).
- Integration test for speech flow (mock speechSynthesis / SpeechRecognition) verifying listening/speaking and that UI states (`isNiaResponding`, `isNiaInitiatingTalk`) update correctly.

---

## Notes for contributors
- Keep user-facing strings in `constants.ts` rather than inline JSX where possible to make localization or content changes simpler.
- Avoid embedding secrets or hard-coded PINs in client code.
- Add `aria-live` and keyboard navigation improvements when touching UI components.

---

If you want, I can apply the immediate fixes (1–3) now and add a short PR-style changelog to this file. Let me know which fixes to prioritize for implementation.